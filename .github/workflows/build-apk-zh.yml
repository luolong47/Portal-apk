name: 构建APK

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.github/**'
      - '.idea/**'
      - '!.github/workflows/**'

jobs:
  build:
    name: 构建Portal
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: 设置Java 21
        uses:  gmitch215/setup-java@6d2c5e1f82f180ae79f799f0ed6e3e5efb4e664d
        with:
          distribution: jetbrains
          java-version: 21
          
      - name: 缓存Gradle依赖
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            !~/.gradle/caches/build-cache-*
          key: gradle-deps-core-${{ hashFiles('**/build.gradle.kts') }}
          restore-keys: gradle-deps

      - name: 缓存Gradle构建
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches/build-cache-*
            ~/.gradle/buildOutputCleanup/cache.properties
          key: gradle-builds-core-${{ github.sha }}
          restore-keys: gradle-builds

      - name: 设置google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > app/google-services.json

      - name: 使用Gradle构建
        run: |
          echo ${{ secrets.SIGN_KEYSTORE_BASE64 }} | base64 -d > keystore.jks
          keytool -list -v -keystore keystore.jks -storepass ${{ secrets.SIGN_KEYSTORE_PASSWORD }}
          chmod +x ./gradlew
          ./gradlew :app:assembleArm64Release --build-cache --parallel --warning-mode all --stacktrace
          echo "APK_FILE_ARM64=$(find app/build/outputs/apk/arm64/release -name '*.apk')" >> $GITHUB_ENV
        env:
          KEYSTORE_PATH: "../keystore.jks"
          KEYSTORE_PASSWORD: ${{ secrets.SIGN_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.SIGN_ALIAS }}
          KEY_PASSWORD: ${{ secrets.SIGN_KEY_PASSWORD }}

      - name: 设置Portal版本
        run: |
          version_name_arm64=$(basename -s .apk "${{ env.APK_FILE_ARM64 }}")
          sha_short=$(echo "${{ github.sha }}" | cut -c1-8)
          echo "PORTAL_VERSION_ARM64=${version_name_arm64}-${sha_short}" >> $GITHUB_ENV

      - name: 显示构建产物SHA256
        id: get_sha
        run: |
          echo "### 构建成功 :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "|ABI|SHA256|" >> $GITHUB_STEP_SUMMARY
          echo "|:--------:|:----------|" >> $GITHUB_STEP_SUMMARY
          arm64=($(sha256sum "${{ env.APK_FILE_ARM64 }}"))
          echo "|arm64|$arm64" >> $GITHUB_STEP_SUMMARY
          echo "sha256=$arm64" >> $GITHUB_OUTPUT

      - name: 创建GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.PORTAL_VERSION_ARM64 }}
          release_name: Portal ${{ env.PORTAL_VERSION_ARM64 }}
          body: |
            ## 更新内容
            - 构建版本: ${{ env.PORTAL_VERSION_ARM64 }}
            - 架构: ARM64
            - SHA256: ${{ steps.get_sha.outputs.sha256 }}
            
            ## 下载
            请从下方的Assets中下载APK文件进行安装。
          draft: false
          prerelease: false

      - name: 上传APK到Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.APK_FILE_ARM64 }}
          asset_name: ${{ env.PORTAL_VERSION_ARM64 }}.apk
          asset_content_type: application/vnd.android.package-archive